name: Build and test PyTorch benchmark
on:
  # Have the ability to trigger this job manually using the API as well
  workflow_dispatch:

jobs:
  build-docker:
    runs-on: ubuntu-18.04
    steps:
      - uses: actions/checkout@v2
        with:
          ref: master
          path: main
      - uses: actions/checkout@v2
        with:
          repository: pytorch/benchmark
          ref: master
          path: benchmark
      - name: Setup CI
        run: |
          bash main/.github/scripts/gh-runner/setup_ci.sh
      - name: Install Conda
        run: |
          bash main/.github/scripts/gh-runner/install_basics.sh
      - name: Install CUDA 10.2
        run: |
          sudo bash main/.github/scripts/gh-runner/install_cuda.sh 10.2 && export PATH=/usr/local/cuda/bin/:$PATH
      - name: Install PyTorch nightly
        run: |
          sudo bash main/.github/scripts/gh-runner/install_nightly.sh 10.2
      - name: Setup benchmark suite dependencies
        run: |
          . ~/miniconda3/etc/profile.d/conda.sh; conda activate base; pushd benchmark; python install.py
      - name: Validate training benchmark suite
        run: |
          . ~/miniconda3/etc/profile.d/conda.sh; conda activate base; pushd benchmark; python test.py
      - name: Validate pytest-benchmark invocation of training suite
        run: |
          pushd benchmark; ./scripts/run_bench_and_upload.sh


